{"version":3,"file":"new-features-service.js","mappings":"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","sources":["webpack://NewFeatureLibrary/webpack/universalModuleDefinition","webpack://NewFeatureLibrary/webpack/bootstrap","webpack://NewFeatureLibrary/webpack/runtime/define property getters","webpack://NewFeatureLibrary/webpack/runtime/hasOwnProperty shorthand","webpack://NewFeatureLibrary/webpack/runtime/make namespace object","webpack://NewFeatureLibrary/./src/compatibility-service.ts","webpack://NewFeatureLibrary/./src/new-features-service.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"NewFeatureLibrary\"] = factory();\n\telse\n\t\troot[\"NewFeatureLibrary\"] = factory();\n})(self, function() {\nreturn ","// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = function(exports, definition) {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }","// define __esModule on exports\n__webpack_require__.r = function(exports) {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export class CompatibilityService {\n  private _groups: number[];\n\n  constructor(groups: number[]) {\n    this._groups = groups;\n  }\n\n  public compatible(feature: number, visibleFeatures: number): number {\n    if (!feature) return feature;\n\n    for (let i = 0; i < this._groups.length; i++) {\n      const gr = this._groups[i];\n      if (!visibleFeatures || gr & visibleFeatures) {\n        const compatibleFeatures = feature & gr;\n        if (compatibleFeatures) return compatibleFeatures;\n      }\n    }\n\n    return 0;\n  }\n}\n","import { NewFeaturesProvider } from './new-features-provider';\nimport { CompatibilityService } from './compatibility-service';\n\nexport class NewFeaturesService {\n  public get shownNewFeatures(): number {\n    return this._shownNewFeatures;\n  }\n\n  private _shownNewFeatures = 0;\n  private _promise$: Promise<number> | undefined;\n  private _compatibilityService: CompatibilityService;\n\n  private readonly _subscriptions: (() => void)[] = [];\n  private readonly _pushSubscriptions: (() => void)[] = [];\n\n  private get _newFeatures$(): Promise<number> {\n    if (!this._promise$) this._promise$ = this._provider.getNewFeatures();\n    return this._promise$;\n  }\n\n  constructor(private readonly _provider: NewFeaturesProvider, compatibilityGroups: number[]) {\n    this._compatibilityService = new CompatibilityService(compatibilityGroups);\n  }\n\n  public async availableFeatures(feature: number): Promise<number> {\n    const curNewFeatures = (await this._newFeatures$) & feature;\n    return curNewFeatures & this._compatibilityService.compatible(curNewFeatures, this._shownNewFeatures);\n  }\n\n  public async showAvailableFeatures(feature: number): Promise<number> {\n    const newFeatures = await this.availableFeatures(feature);\n    if (newFeatures) this._shownNewFeatures |= newFeatures;\n    return newFeatures;\n  }\n\n  public async isNewFeature(feature: number): Promise<boolean> {\n    const newFeatures = await this.availableFeatures(feature);\n    return (newFeatures & feature) === feature;\n  }\n\n  public async markNewFeatureAsUsed(feature: number): Promise<boolean> {\n    const isNew = await this.isNewFeature(feature);\n    if (isNew) this._provider.markNewFeatureAsUsed(feature);\n    return isNew;\n  }\n\n  public hide(feature: number): void {\n    this._shownNewFeatures &= ~feature;\n  }\n\n  public subscribeOnChangeState(fn: () => void): void {\n    if (this._subscriptions.find(f => f === fn)) return;\n    this._subscriptions.push(fn);\n    if (this._subscriptions.length === 1) this.subscribeListener(this.refreshNewFeatures);\n  }\n\n  public unsubscribeFromChangeState(fn: () => void): void {\n    const index = this._subscriptions.indexOf(fn);\n    if (index === -1) return;\n\n    this._subscriptions.splice(index, 1);\n    if (!this._subscriptions.length) this.unsubscribeListener(this.refreshNewFeatures);\n  }\n\n  private refreshNewFeatures = (): void => {\n    this._promise$ = this._provider.getNewFeatures();\n    this._newFeatures$.then(() => { this._subscriptions.forEach(fn => fn()); });\n  };\n\n  private subscribeListener(fn: () => void): void {\n    if (this._pushSubscriptions.find(f => f === fn)) return;\n    this._pushSubscriptions.push(fn);\n    if (this._pushSubscriptions.length === 1) this._provider.startListenPushes(this.update.bind(this));\n  }\n\n  private unsubscribeListener(fn: () => void): void {\n    const index = this._pushSubscriptions.indexOf(fn);\n    if (index === -1) return;\n\n    this._pushSubscriptions.splice(index, 1);\n    if (!this._pushSubscriptions.length) this._provider.stopListenPushes();\n  }\n\n  private update(): void {\n    this._pushSubscriptions.forEach(fn => fn());\n  }\n}\n"],"names":["CompatibilityService","constructor","groups","_defineProperty","_groups","compatible","feature","visibleFeatures","i","length","gr","compatibleFeatures","NewFeaturesService","shownNewFeatures","_shownNewFeatures","_newFeatures$","_promise$","_provider","getNewFeatures","compatibilityGroups","then","_subscriptions","forEach","fn","_compatibilityService","availableFeatures","curNewFeatures","showAvailableFeatures","newFeatures","isNewFeature","markNewFeatureAsUsed","isNew","hide","subscribeOnChangeState","find","f","push","subscribeListener","refreshNewFeatures","unsubscribeFromChangeState","index","indexOf","splice","unsubscribeListener","_pushSubscriptions","startListenPushes","update","bind","stopListenPushes"],"sourceRoot":""}